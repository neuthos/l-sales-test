name: Auto PR to Release

on:
  pull_request:
    types:
      - closed
    branches:
      - staging

permissions:
  contents: write
  pull-requests: write

jobs:
  create-release-pr:
    # Only run if PR was merged (not just closed)
    if: github.event.pull_request.merged == true
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Get current date
        id: date
        run: echo "date=$(date +'%Y-%m-%d')" >> $GITHUB_OUTPUT

      - name: Create release branch
        env:
          RELEASE_BRANCH: release/${{ steps.date.outputs.date }}
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"

          # Check if branch exists
          if git ls-remote --heads origin $RELEASE_BRANCH | grep -q $RELEASE_BRANCH; then
            echo "‚ÑπÔ∏è Branch $RELEASE_BRANCH already exists"
            git fetch origin $RELEASE_BRANCH
            git checkout $RELEASE_BRANCH
          else
            echo "‚ú® Creating new branch $RELEASE_BRANCH"
            git checkout -b $RELEASE_BRANCH
            git push origin $RELEASE_BRANCH
          fi

      - name: Check for existing PR
        id: check-pr
        env:
          GH_TOKEN: ${{ github.token }}
          RELEASE_BRANCH: release/${{ steps.date.outputs.date }}
        run: |
          PR_COUNT=$(gh pr list --base $RELEASE_BRANCH --head staging --state open --json number --jq 'length')
          echo "pr_count=$PR_COUNT" >> $GITHUB_OUTPUT

      - name: Create PR to release branch
        if: steps.check-pr.outputs.pr_count == '0'
        env:
          GH_TOKEN: ${{ github.token }}
          RELEASE_BRANCH: release/${{ steps.date.outputs.date }}
          RELEASE_DATE: ${{ steps.date.outputs.date }}
        run: |
          gh pr create \
            --base $RELEASE_BRANCH \
            --head staging \
            --title "üì¶ Release $RELEASE_DATE - Ready for Production" \
            --body "## Release Branch: $RELEASE_DATE

          This PR was automatically created after merging to \`staging\`.

          ### Pre-Production Checklist:
          - [ ] QA testing completed on staging
          - [ ] All tests passing
          - [ ] Documentation updated
          - [ ] Release notes prepared

          ### Deployment Steps:
          1. Review all changes in this PR
          2. Merge this PR to create production-ready release
          3. Create final PR: \`$RELEASE_BRANCH ‚Üí master\`
          4. Add version label (PATCH/MINOR/MAJOR) to master PR
          5. Merge to master for production deployment

          ### Version Bump:
          When creating PR to \`master\`, add one of these labels:
          - üü¢ **PATCH** - Bug fixes (0.0.X) - *default if no label*
          - üîµ **MINOR** - New features (0.X.0)
          - üî¥ **MAJOR** - Breaking changes (X.0.0)

          ---
          *Generated by GitHub Actions*"

      - name: PR already exists
        if: steps.check-pr.outputs.pr_count != '0'
        run: |
          echo "‚ÑπÔ∏è PR from staging to release/${{ steps.date.outputs.date }} already exists. Skipping PR creation."
